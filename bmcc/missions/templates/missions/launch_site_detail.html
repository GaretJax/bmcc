{% extends "missions/base.html" %}

{% block title %}Launch site: {{ launch_site.name }}{% endblock %}

{% block content %}
<div class="card">
    <div class="grid-x align-justify align-middle"
         style="margin-bottom: 0.75rem;">
        <div class="cell auto">
            <h2 class="h4">{{ launch_site.name }}</h2>
            <p class="muted">
                Mission: {{ mission.name }}
            </p>
        </div>
        <div class="cell shrink">
            <a class="button hollow tiny"
               href="{% url 'missions:launch_site_update' mission_id=mission.pk launch_site_id=launch_site.pk %}">
                Edit launch time
            </a>
        </div>
    </div>
    <form method="post"
          action="{% url 'missions:launch_site_predict' mission_id=mission.pk launch_site_id=launch_site.pk %}">
        {% csrf_token %}
        <button class="button primary small" type="submit">Run prediction</button>
    </form>
    <dl>
        <dt>Location</dt>
        <dd>{{ launch_site.location.y|floatformat:5 }}, {{ launch_site.location.x|floatformat:5 }}</dd>
        <dt>Altitude</dt>
        <dd>{% if launch_site.altitude %}{{ launch_site.altitude }} m{% else %}—{% endif %}</dd>
        <dt>Intended launch at</dt>
        <dd>{% if launch_site.intended_launch_at %}{{ launch_site.intended_launch_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}</dd>
    </dl>
    <div style="margin-top: 1rem;">
        <div id="launch-map" style="height: 320px; border: 1px solid #e0e0e0;"></div>
    </div>
</div>

<div class="card">
    <h3 class="h5" style="margin-bottom: 0.5rem;">Recent predictions</h3>
    <table class="stack">
        <thead>
            <tr>
                <th>Created</th>
                <th>Ascent / Burst / Descent</th>
                <th>Burst</th>
                <th>Landing</th>
            </tr>
        </thead>
        <tbody>
            {% for prediction in launch_site.prediction_history.all|slice:":3" %}
                <tr>
                    <td>{{ prediction.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {{ prediction.additional_parameters.ascent_rate|default:"—" }} /
                        {{ prediction.additional_parameters.burst_altitude|default:"—" }} /
                        {{ prediction.additional_parameters.descent_rate|default:"—" }}
                    </td>
                    <td>
                        {% if prediction.bursting_at %}{{ prediction.bursting_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}<br>
                        {% if prediction.burst_altitude %}{{ prediction.burst_altitude }} m{% else %}—{% endif %}<br>
                        {% if prediction.burst_location %}{{ prediction.burst_location.y|floatformat:5 }}, {{ prediction.burst_location.x|floatformat:5 }}{% else %}—{% endif %}
                    </td>
                    <td>
                        {% if prediction.landing_at %}{{ prediction.landing_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}<br>
                        {% if prediction.landing_location %}{{ prediction.landing_location.y|floatformat:5 }}, {{ prediction.landing_location.x|floatformat:5 }}{% else %}—{% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="text-center muted">No predictions yet.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if last_prediction and last_prediction.prediction %}
    {{ last_prediction.prediction|json_script:"prediction-data" }}
{% endif %}
{% endblock %}

{% block extra_body %}
{{ block.super }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    (function () {
        var mapEl = document.getElementById("launch-map");
        if (!mapEl || !window.L) { return; }
        var lat = {{ launch_site.location.y }};
        var lon = {{ launch_site.location.x }};
        var map = L.map("launch-map").setView([lat, lon], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
        var launchPoint = {% if last_prediction and last_prediction.launch_location %}[{{ last_prediction.launch_location.y }}, {{ last_prediction.launch_location.x }}]{% else %}[lat, lon]{% endif %};
        var launchTime = {% if last_prediction and last_prediction.launch_at %}"{{ last_prediction.launch_at|date:"c" }}"{% elif launch_site.intended_launch_at %}"{{ launch_site.intended_launch_at|date:"c" }}"{% else %}null{% endif %};
        var launchAlt = {% if last_prediction and last_prediction.launch_altitude %}{{ last_prediction.launch_altitude }}{% elif launch_site.altitude %}{{ launch_site.altitude }}{% else %}null{% endif %};
        var burstPoint = {% if last_prediction and last_prediction.burst_location %}[{{ last_prediction.burst_location.y }}, {{ last_prediction.burst_location.x }}]{% else %}null{% endif %};
        var burstTime = {% if last_prediction and last_prediction.bursting_at %}"{{ last_prediction.bursting_at|date:"c" }}"{% else %}null{% endif %};
        var burstAlt = {% if last_prediction and last_prediction.burst_altitude %}{{ last_prediction.burst_altitude }}{% else %}null{% endif %};
        var landingPoint = {% if last_prediction and last_prediction.landing_location %}[{{ last_prediction.landing_location.y }}, {{ last_prediction.landing_location.x }}]{% else %}null{% endif %};
        var landingTime = {% if last_prediction and last_prediction.landing_at %}"{{ last_prediction.landing_at|date:"c" }}"{% else %}null{% endif %};
        var landingAlt = {% if last_prediction and last_prediction.landing_altitude %}{{ last_prediction.landing_altitude }}{% else %}null{% endif %};
        var predEl = document.getElementById("prediction-data");
        if (predEl) {
            try {
                var pred = JSON.parse(predEl.textContent);
                var coords = [];
                var startPoint, burstPoint, landingPoint;
                if (pred && pred.prediction) {
                    pred.prediction.forEach(function (segment, idx) {
                        (segment.trajectory || []).forEach(function (p, pIdx) {
                            if (
                                typeof p.latitude !== "undefined" &&
                                typeof p.longitude !== "undefined"
                            ) {
                                coords.push([p.latitude, p.longitude]);
                                if (idx === 0 && pIdx === 0) {
                                    startPoint = [p.latitude, p.longitude];
                                }
                                if (idx === 0 && pIdx === (segment.trajectory.length - 1)) {
                                    burstPoint = [p.latitude, p.longitude];
                                }
                                if (idx === 1 && pIdx === (segment.trajectory.length - 1)) {
                                    landingPoint = [p.latitude, p.longitude];
                                }
                            }
                        });
                    });
                }
                if (launchPoint) {
                    L.marker(launchPoint, { title: "Launch", icon: launchIcon })
                        .addTo(map)
                        .bindPopup(formatPopup("Launch", launchTime, launchAlt));
                }
                if (!coords.length) {
                    var fallback = [];
                    if (launchPoint) { fallback.push(launchPoint); }
                    if (burstPoint) { fallback.push(burstPoint); }
                    if (landingPoint) { fallback.push(landingPoint); }
                    if (fallback.length >= 2) {
                        coords = fallback;
                    }
                }
                if (coords.length) {
                    var line = L.polyline(coords, { color: "#1779ba" });
                    line.addTo(map);
                    map.fitBounds(line.getBounds(), { padding: [10, 10] });
                    var launchIcon = L.icon({
                        iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                    });
                    var burstIcon = L.divIcon({
                        html: "&#x1F4A5;",
                        className: "burst-icon",
                        iconSize: [24, 24],
                    });
                    var landingIcon = L.divIcon({
                        html: "&#x1F6A7;",
                        className: "landing-icon",
                        iconSize: [24, 24],
                    });
                    function formatPopup(label, time, altitude) {
                        var parts = [label];
                        if (time) {
                            parts.push("Time: " + time);
                        }
                        if (altitude !== undefined && altitude !== null) {
                            parts.push("Alt: " + altitude + " m");
                        }
                        return parts.join("<br>");
                    }
                    if (burstPoint) {
                        L.marker(burstPoint, { title: "Burst", icon: burstIcon })
                            .addTo(map)
                            .bindPopup(formatPopup("Burst", burstTime, burstAlt));
                    }
                    if (landingPoint) {
                        L.marker(landingPoint, { title: "Landing", icon: landingIcon })
                            .addTo(map)
                            .bindPopup(formatPopup("Landing", landingTime, landingAlt));
                    }
                }
            } catch (e) {
                console.warn("Could not render prediction track", e);
            }
        }
    }());
</script>
{% endblock %}
