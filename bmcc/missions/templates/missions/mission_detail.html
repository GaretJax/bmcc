{% extends "missions/base.html" %}

{% block title %}Mission: {{ mission.name }}{% endblock %}

{% block extra_head %}
{{ block.super }}
{% endblock %}

{% block content %}
<div class="grid-x grid-margin-x">
    <div class="cell">
        <p class="muted">
            {{ mission.description|default:"No description provided for this mission." }}
        </p>
    </div>
</div>

<div class="grid-x grid-margin-x">
    <div class="cell medium-4">
        <div class="card text-center">
            <p class="muted">Assets</p>
            <p class="h2">{{ assets|length }}</p>
        </div>
    </div>
    <div class="cell medium-4">
        <div class="card text-center">
            <p class="muted">Beacons</p>
            <p class="h2">{{ beacon_count }}</p>
        </div>
    </div>
    <div class="cell medium-4">
        <div class="card text-center">
            <p class="muted">Launch sites</p>
            <p class="h2">{{ mission.launch_site_candidates.all|length }}</p>
        </div>
    </div>
</div>

<section class="card">
    <div class="grid-x align-middle align-justify" style="margin-bottom: 0.5rem;">
        <h3 class="h5">Mission parameters</h3>
        <div>
            <a class="button hollow tiny"
               href="{% url 'missions:mission_parameters' mission_id=mission.pk %}">Edit</a>
        </div>
    </div>
    <table class="unstriped">
        <tbody>
            <tr>
                <th width="200">Ascent speed</th>
                <td>{% if mission.ascent_rate %}{{ mission.ascent_rate }} m/s{% else %}—{% endif %}</td>
            </tr>
            <tr>
                <th>Target burst altitude</th>
                <td>{% if mission.burst_altitude %}{{ mission.burst_altitude }} m{% else %}—{% endif %}</td>
            </tr>
            <tr>
                <th>Descent speed</th>
                <td>{% if mission.descent_rate %}{{ mission.descent_rate }} m/s{% else %}—{% endif %}</td>
            </tr>
        </tbody>
    </table>
</section>

{% for asset in assets %}
<section class="card">
    <div class="grid-x align-justify align-middle">
        <div class="cell auto">
            <h2 class="h4">{{ asset.name }}</h2>
            <p class="muted">
                {{ asset.get_asset_type_display }}
                {% if asset.callsign %} &middot; {{ asset.callsign }}{% endif %}
            </p>
        </div>
        <div class="cell shrink muted">Beacons: {{ asset.beacons.all|length }}</div>
    </div>
    {% if asset.notes %}
        <p>{{ asset.notes }}</p>
    {% endif %}

    <div class="grid-x grid-margin-x">
        {% for beacon in asset.beacons.all %}
            <div class="cell medium-6 large-4">
                <div class="card">
                    <div class="grid-x align-middle align-justify">
                        <div class="cell auto">
                            <p class="h5" style="margin-bottom: 0.25rem;">{{ beacon.identifier }}</p>
                            {% if beacon.description %}
                                <p class="muted">{{ beacon.description }}</p>
                            {% endif %}
                        </div>
                        <span class="label {% if beacon.active %}success{% else %}alert{% endif %}">
                            {% if beacon.active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                    {% with ping=beacon.latest_ping.0 %}
                        {% if ping %}
                            <table class="unstriped" style="margin-bottom: 0;">
                                <tbody>
                                    <tr>
                                        <th width="120">Last ping</th>
                                        <td>{{ ping.reported_at|date:"Y-m-d H:i" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Position</th>
                                        <td>
                                            {{ ping.latitude|floatformat:5 }},
                                            {{ ping.longitude|floatformat:5 }}
                                        </td>
                                    </tr>
                                    {% if ping.altitude %}
                                        <tr>
                                            <th>Altitude</th>
                                            <td>{{ ping.altitude }} m</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="muted">No pings received yet.</p>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
        {% empty %}
            <p class="muted">This asset has no beacons yet.</p>
        {% endfor %}
    </div>
</section>
{% empty %}
<section class="card text-center">
    No assets assigned to this mission yet.
</section>
{% endfor %}
{% endblock %}
