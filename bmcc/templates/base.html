{% load django_htmx %}<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Ballooning Mission Control{% endblock %}</title>
    <link rel="stylesheet"
        href="//unpkg.com/foundation-sites/dist/css/foundation.min.css">
    {% htmx_script %}
    <style>
        :root { --topbar-height: 72px; }
        body { background: #f6f8fb; margin: 0; overflow-x: hidden; }
        .topbar {
            display: grid;
            grid-template-columns: 240px 1fr;
            align-items: center;
            background: #0a2140;
            color: #e7edf5;
            padding: 1rem 1.5rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.25);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--topbar-height);
            z-index: 10;
            width: 100%;
            box-sizing: border-box;
        }
        .topbar .title { font-size: 1.1rem; margin: 0; }
        .topbar .nav-right { justify-self: end; color: #cfd8e3; }
        .app-shell {
            margin-top: var(--topbar-height);
            min-height: calc(100vh - var(--topbar-height));
            display: grid;
            grid-template-columns: 240px 1fr;
            width: 100%;
            box-sizing: border-box;
        }
        .sidebar-panel {
            background: #0d274a;
            color: #e7edf5;
            padding: 1.5rem 1.25rem;
            position: sticky;
            top: var(--topbar-height);
            height: calc(100vh - var(--topbar-height));
        }
        .sidebar-panel a { color: #e7edf5; }
        .sidebar-panel .menu a.disabled { color: #8fa3bf; }
        .sidebar-panel .menu-text { color: #8fa3bf; font-size: 0.85rem; }
        .content-area {
            padding: 2rem 2rem 3rem;
        }
        .page-shell {
            max-width: 1100px;
            margin: 0 auto;
        }
        .header { margin-bottom: 1.5rem; }
        .header h1 { margin-bottom: 0.25rem; }
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            padding: 1.25rem;
            border: 1px solid #e6e8eb;
        }
        .muted { color: #5c6c7c; }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body hx-headers='{"x-csrftoken": "{{ csrf_token }}"}'>
    <div class="topbar">
        <div>
            <p class="title">
                {% if mission %}
                    {{ mission.name }}
                {% else %}
                    Ballooning Mission Control
                {% endif %}
            </p>
        </div>
        <div class="nav-right">
            <button id="toggle-refresh"
                    class="button small secondary hollow"
                    type="button">
                Pause refresh
            </button>
            {% if mission %}
            <a class="button small hollow"
               href="{% url 'missions:kml_entrypoint' mission_id=mission.pk %}">
                Google Earth KML
            </a>
            {% endif %}
            {% block topbar_right %}{% endblock %}
        </div>
    </div>
    <div class="app-shell">
        <aside class="sidebar-panel">
            {% with mission as nav_mission %}
            <ul class="vertical menu">
                <li>
                    <span class="menu-text">Navigation</span>
                </li>
{% if nav_mission %}
{% url 'tracking:owntracks_register' pk=nav_mission.pk as owntracks_register %}
{% url 'missions:asset_list' mission_id=nav_mission.pk as mission_assets_url %}
{% url 'missions:launch_site_list' mission_id=nav_mission.pk as launch_sites_url %}
                    <li>
                        <a href="{{ nav_mission.get_absolute_url }}">
                            Mission Overview
                        </a>
                    </li>
                    <li>
                        <a href="{{ launch_sites_url }}">
                            Launch Sites
                        </a>
                    </li>
                    <li>
                        <a href="{{ mission_assets_url }}">
                            Assets
                        </a>
                    </li>
                    <li>
                        <a href="{{ owntracks_register }}">
                            Register OwnTracks device
                        </a>
                    </li>
                {% else %}
                    <li>
                        <a aria-disabled="true" class="disabled">
                            Mission Overview
                        </a>
                    </li>
                    <li>
                        <a aria-disabled="true" class="disabled">
                            Register OwnTracks device
                        </a>
                    </li>
                {% endif %}
                {% block sidebar_menu_extra %}{% endblock %}
            </ul>
            {% endwith %}
        </aside>
        <div class="content-area">
            <div class="page-shell">
                <header class="header">
                    {% block header %}{% endblock %}
                </header>
                <main>
                    {% block content %}{% endblock %}
                </main>
            </div>
        </div>
    </div>
    {% block extra_body %}{% endblock %}
    <script>
        var refreshPaused = false;

        document.addEventListener("DOMContentLoaded", function () {
            var toggle = document.getElementById("toggle-refresh");
            if (toggle) {
                toggle.addEventListener("click", function () {
                    refreshPaused = !refreshPaused;
                    toggle.textContent = refreshPaused
                        ? "Resume refresh"
                        : "Pause refresh";
                    document.body.classList.toggle(
                        "refresh-paused",
                        refreshPaused
                    );
                });
            }
        });

        function renderAltitudeChart(container) {
            if (!window.Chart || !container) { return; }
            var dataEl = container.querySelector("#altitude-series-data");
            var canvas = container.querySelector("#altitude-chart");
            if (!dataEl || !canvas) { return; }
            canvas.parentElement.style.visibility = "hidden";
            var seriesByBeacon = {};
            try {
                seriesByBeacon = JSON.parse(dataEl.textContent) || {};
            } catch (e) {
                canvas.parentElement.style.visibility = "visible";
                return;
            }
            var datasets = [];
            var palette = [
                "#1779ba",
                "#ff7f50",
                "#2ca02c",
                "#9467bd",
                "#e377c2",
                "#bcbd22",
                "#17becf",
            ];
            var idx = 0;
            var nullPoints = [];
            Object.keys(seriesByBeacon).forEach(function (beacon) {
                var points = seriesByBeacon[beacon] || [];
                var validPoints = [];
                points.forEach(function (item) {
                    if (!item || item.length < 2) { return; }
                    var altitude = item[2] !== undefined ? item[2] : item[1];
                    var timestamp = item[0];
                    if (altitude === null) {
                        nullPoints.push({ x: timestamp, y: 0 });
                    } else {
                        validPoints.push({ x: timestamp, y: altitude });
                    }
                });
                datasets.push({
                    label: beacon,
                    data: validPoints,
                    borderColor: palette[idx % palette.length],
                    backgroundColor: palette[idx % palette.length] + "33",
                    tension: 0,
                });
                idx += 1;
            });
            if (nullPoints.length) {
                datasets.push({
                    label: "No altitude",
                    data: nullPoints,
                    borderColor: "#aaaaaa",
                    backgroundColor: "#dddddd",
                    showLine: false,
                    pointRadius: 4,
                });
            }
            var allTimes = datasets
                .flatMap(function (ds) {
                    return ds.data;
                })
                .map(function (pt) {
                    return pt.x;
                });
            var minTime =
                allTimes.length > 0
                    ? Math.min.apply(
                          null,
                          allTimes.map(function (t) {
                              return new Date(t).getTime();
                          })
                      )
                    : null;
            var maxTime =
                allTimes.length > 0
                    ? Math.max.apply(
                          null,
                          allTimes.map(function (t) {
                              return new Date(t).getTime();
                          })
                      )
                    : null;
            if (container._chartInstance) {
                container._chartInstance.data.datasets = datasets;
                container._chartInstance.update();
            } else {
                container._chartInstance = new Chart(canvas, {
                    type: "line",
                    data: {
                        datasets: datasets,
                    },
                    options: {
                        plugins: { legend: { display: true } },
                        scales: {
                            x: {
                                type: "time",
                                time: { tooltipFormat: "PPpp" },
                                title: { display: true, text: "Time" },
                            },
                            y: {
                                title: { display: true, text: "Altitude (m)" },
                                ticks: { padding: 12 },
                                afterFit: function (scale) {
                                    scale.width = Math.max(scale.width, 120);
                                },
                            },
                        },
                    },
                });
            }
            canvas.parentElement.style.visibility = "visible";
            return { minTime: minTime, maxTime: maxTime };
        }

        function renderSpeedChart(container) {
            if (!window.Chart || !container) { return; }
            var dataEl = container.querySelector("#speed-series-data");
            var canvas = container.querySelector("#speed-chart");
            if (!dataEl || !canvas) { return; }
            canvas.parentElement.style.visibility = "hidden";
            var seriesByBeacon = {};
            try {
                seriesByBeacon = JSON.parse(dataEl.textContent) || {};
            } catch (e) {
                canvas.parentElement.style.visibility = "visible";
                return;
            }
            var datasets = [];
            var palette = [
                "#1779ba",
                "#ff7f50",
                "#2ca02c",
                "#9467bd",
                "#e377c2",
                "#bcbd22",
                "#17becf",
            ];
            var idx = 0;
            Object.keys(seriesByBeacon).forEach(function (beacon) {
                var points = (seriesByBeacon[beacon] || []).filter(function (
                    item
                ) {
                    return item && item.length >= 2 && item[1] !== null;
                });
                datasets.push({
                    label: beacon,
                    data: points.map(function (item) {
                        return { x: item[0], y: item[1] };
                    }),
                    borderColor: palette[idx % palette.length],
                    backgroundColor: palette[idx % palette.length] + "33",
                    tension: 0,
                });
                idx += 1;
            });
            var allTimes = datasets
                .flatMap(function (ds) {
                    return ds.data;
                })
                .map(function (pt) {
                    return pt.x;
                });
            var minTime =
                allTimes.length > 0
                    ? Math.min.apply(
                          null,
                          allTimes.map(function (t) {
                              return new Date(t).getTime();
                          })
                      )
                    : null;
            var maxTime =
                allTimes.length > 0
                    ? Math.max.apply(
                          null,
                          allTimes.map(function (t) {
                              return new Date(t).getTime();
                          })
                      )
                    : null;
            var boundsEl = container.querySelector("#chart-bounds-data");
            var bounds = {};
            if (boundsEl) {
                try {
                    bounds = JSON.parse(boundsEl.textContent) || {};
                } catch (e) {
                    bounds = {};
                }
            }
            var forcedMin =
                bounds.start !== undefined && bounds.start !== null
                    ? new Date(bounds.start).getTime()
                    : null;
            var forcedMax =
                bounds.end !== undefined && bounds.end !== null
                    ? new Date(bounds.end).getTime()
                    : null;
            if (container._chartInstance) {
                container._chartInstance.data.datasets = datasets;
                if (forcedMin !== null) {
                    container._chartInstance.options.scales.x.min = forcedMin;
                }
                if (forcedMax !== null) {
                    container._chartInstance.options.scales.x.max = forcedMax;
                }
                container._chartInstance.update();
            } else {
                container._chartInstance = new Chart(canvas, {
                    type: "line",
                    data: { datasets: datasets },
                    options: {
                        plugins: { legend: { display: true } },
                        scales: {
                            x: {
                                type: "time",
                                time: { tooltipFormat: "PPpp" },
                                title: { display: true, text: "Time" },
                                min:
                                    forcedMin !== null
                                        ? forcedMin
                                        : minTime,
                                max:
                                    forcedMax !== null
                                        ? forcedMax
                                        : maxTime,
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: "Vertical speed (m/s)",
                                },
                                ticks: { padding: 12 },
                                afterFit: function (scale) {
                                    scale.width = Math.max(scale.width, 120);
                                },
                            },
                        },
                    },
                });
            }
            canvas.parentElement.style.visibility = "visible";
            return { minTime: minTime, maxTime: maxTime };
        }

        function renderHorizontalChart(container) {
            if (!window.Chart || !container) { return; }
            var dataEl = container.querySelector(
                "#horizontal-speed-series-data"
            );
            var canvas = container.querySelector("#horizontal-speed-chart");
            if (!dataEl || !canvas) { return; }
            canvas.parentElement.style.visibility = "hidden";
            var seriesByBeacon = {};
            try {
                seriesByBeacon = JSON.parse(dataEl.textContent) || {};
            } catch (e) {
                canvas.parentElement.style.visibility = "visible";
                return;
            }
            var boundsEl = container.querySelector("#chart-bounds-data");
            var bounds = {};
            if (boundsEl) {
                try {
                    bounds = JSON.parse(boundsEl.textContent) || {};
                } catch (e) {
                    bounds = {};
                }
            }
            var datasets = [];
            var palette = [
                "#1779ba",
                "#ff7f50",
                "#2ca02c",
                "#9467bd",
                "#e377c2",
                "#bcbd22",
                "#17becf",
            ];
            var idx = 0;
            Object.keys(seriesByBeacon).forEach(function (beacon) {
                var points = (seriesByBeacon[beacon] || []).filter(function (
                    item
                ) {
                    return item && item.length >= 2 && item[1] !== null;
                });
                datasets.push({
                    label: beacon,
                    data: points.map(function (item) {
                        return { x: item[0], y: item[1] };
                    }),
                    borderColor: palette[idx % palette.length],
                    backgroundColor: palette[idx % palette.length] + "33",
                    tension: 0,
                });
                idx += 1;
            });
            var allTimes = datasets
                .flatMap(function (ds) {
                    return ds.data;
                })
                .map(function (pt) {
                    return pt.x;
                });
            var minTime =
                allTimes.length > 0
                    ? Math.min.apply(
                          null,
                          allTimes.map(function (t) {
                              return new Date(t).getTime();
                          })
                      )
                    : null;
            var maxTime =
                allTimes.length > 0
                    ? Math.max.apply(
                          null,
                          allTimes.map(function (t) {
                              return new Date(t).getTime();
                          })
                      )
                    : null;
            var forcedMin =
                bounds.start !== undefined && bounds.start !== null
                    ? new Date(bounds.start).getTime()
                    : null;
            var forcedMax =
                bounds.end !== undefined && bounds.end !== null
                    ? new Date(bounds.end).getTime()
                    : null;
            if (container._chartInstance) {
                container._chartInstance.data.datasets = datasets;
                if (forcedMin !== null) {
                    container._chartInstance.options.scales.x.min = forcedMin;
                }
                if (forcedMax !== null) {
                    container._chartInstance.options.scales.x.max = forcedMax;
                }
                container._chartInstance.update();
            } else {
                container._chartInstance = new Chart(canvas, {
                    type: "line",
                    data: { datasets: datasets },
                    options: {
                        plugins: { legend: { display: true } },
                        scales: {
                            x: {
                                type: "time",
                                time: { tooltipFormat: "PPpp" },
                                title: { display: true, text: "Time" },
                                min:
                                    forcedMin !== null
                                        ? forcedMin
                                        : minTime,
                                max:
                                    forcedMax !== null
                                        ? forcedMax
                                        : maxTime,
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: "Horizontal speed (m/s)",
                                },
                                ticks: { padding: 12 },
                                afterFit: function (scale) {
                                    scale.width = Math.max(scale.width, 120);
                                },
                            },
                        },
                    },
                });
            }
            canvas.parentElement.style.visibility = "visible";
            return { minTime: minTime, maxTime: maxTime };
        }

        function renderDownrangeChart(container) {
            if (!window.Chart || !container) { return; }
            var dataEl = container.querySelector("#downrange-series-data");
            var canvas = container.querySelector("#downrange-chart");
            if (!dataEl || !canvas) { return; }
            canvas.parentElement.style.visibility = "hidden";
            var seriesByBeacon = {};
            try {
                seriesByBeacon = JSON.parse(dataEl.textContent) || {};
            } catch (e) {
                canvas.parentElement.style.visibility = "visible";
                return;
            }
            var boundsEl = container.querySelector("#chart-bounds-data");
            var bounds = {};
            if (boundsEl) {
                try {
                    bounds = JSON.parse(boundsEl.textContent) || {};
                } catch (e) {
                    bounds = {};
                }
            }
            var datasets = [];
            var palette = [
                "#1779ba",
                "#ff7f50",
                "#2ca02c",
                "#9467bd",
                "#e377c2",
                "#bcbd22",
                "#17becf",
            ];
            var idx = 0;
            Object.keys(seriesByBeacon).forEach(function (beacon) {
                var points = (seriesByBeacon[beacon] || []).filter(function (
                    item
                ) {
                    return item && item.length >= 2 && item[1] !== null;
                });
                datasets.push({
                    label: beacon,
                    data: points.map(function (item) {
                        return { x: item[0], y: item[1] };
                    }),
                    borderColor: palette[idx % palette.length],
                    backgroundColor: palette[idx % palette.length] + "33",
                    tension: 0,
                });
                idx += 1;
            });
            var allTimes = datasets
                .flatMap(function (ds) { return ds.data; })
                .map(function (pt) { return pt.x; });
            var minTime =
                allTimes.length > 0
                    ? Math.min.apply(
                          null,
                          allTimes.map(function (t) {
                              return new Date(t).getTime();
                          })
                      )
                    : null;
            var maxTime =
                allTimes.length > 0
                    ? Math.max.apply(
                          null,
                          allTimes.map(function (t) {
                              return new Date(t).getTime();
                          })
                      )
                    : null;
            var forcedMin =
                bounds.start !== undefined && bounds.start !== null
                    ? new Date(bounds.start).getTime()
                    : null;
            var forcedMax =
                bounds.end !== undefined && bounds.end !== null
                    ? new Date(bounds.end).getTime()
                    : null;
            if (container._chartInstance) {
                container._chartInstance.data.datasets = datasets;
                if (forcedMin !== null) {
                    container._chartInstance.options.scales.x.min = forcedMin;
                }
                if (forcedMax !== null) {
                    container._chartInstance.options.scales.x.max = forcedMax;
                }
                container._chartInstance.update();
            } else {
                container._chartInstance = new Chart(canvas, {
                    type: "line",
                    data: { datasets: datasets },
                    options: {
                        plugins: { legend: { display: true } },
                        scales: {
                            x: {
                                type: "time",
                                time: { tooltipFormat: "PPpp" },
                                title: { display: true, text: "Time" },
                                min:
                                    forcedMin !== null
                                        ? forcedMin
                                        : minTime,
                                max:
                                    forcedMax !== null
                                        ? forcedMax
                                        : maxTime,
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: "Downrange distance (m)",
                                },
                                ticks: { padding: 12 },
                                afterFit: function (scale) {
                                    scale.width = Math.max(scale.width, 120);
                                },
                            },
                        },
                    },
                });
            }
            canvas.parentElement.style.visibility = "visible";
            return { minTime: minTime, maxTime: maxTime };
        }

        document.addEventListener("DOMContentLoaded", function () {
            var chartContainer = document.getElementById(
                "asset-altitude-chart-wrapper"
            );
            var speedContainer = document.getElementById(
                "asset-speed-chart-wrapper"
            );
            var horizontalContainer = document.getElementById(
                "asset-horizontal-speed-chart-wrapper"
            );
            var downrangeContainer = document.getElementById(
                "asset-downrange-chart-wrapper"
            );
            var altRange = chartContainer
                ? renderAltitudeChart(chartContainer)
                : null;
            var speedRange = speedContainer
                ? renderSpeedChart(speedContainer)
                : null;
            var horizontalRange = horizontalContainer
                ? renderHorizontalChart(horizontalContainer)
                : null;
            var downrangeRange = downrangeContainer
                ? renderDownrangeChart(downrangeContainer)
                : null;
            var ranges = [
                altRange,
                speedRange,
                horizontalRange,
                downrangeRange,
            ].filter(Boolean);
            if (ranges.length > 0) {
                var globalMin = Math.min.apply(
                    null,
                    ranges.map(function (r) { return r.minTime; })
                );
                var globalMax = Math.max.apply(
                    null,
                    ranges.map(function (r) { return r.maxTime; })
                );
                if (chartContainer && chartContainer._chartInstance) {
                    chartContainer._chartInstance.options.scales.x.min =
                        globalMin;
                    chartContainer._chartInstance.options.scales.x.max =
                        globalMax;
                    chartContainer._chartInstance.update();
                }
                if (speedContainer && speedContainer._chartInstance) {
                    speedContainer._chartInstance.options.scales.x.min =
                        globalMin;
                    speedContainer._chartInstance.options.scales.x.max =
                        globalMax;
                    speedContainer._chartInstance.update();
                }
                if (
                    horizontalContainer
                    && horizontalContainer._chartInstance
                ) {
                    horizontalContainer._chartInstance.options.scales.x.min =
                        globalMin;
                    horizontalContainer._chartInstance.options.scales.x.max =
                        globalMax;
                    horizontalContainer._chartInstance.update();
                }
                if (
                    downrangeContainer
                    && downrangeContainer._chartInstance
                ) {
                    downrangeContainer._chartInstance.options.scales.x.min =
                        globalMin;
                    downrangeContainer._chartInstance.options.scales.x.max =
                        globalMax;
                    downrangeContainer._chartInstance.update();
                }
            }

            document.body.addEventListener("htmx:configRequest", function (e) {
                if (refreshPaused) {
                    e.preventDefault();
                }
            });

            document.body.addEventListener("htmx:beforeRequest", function (e) {
                if (refreshPaused) {
                    e.preventDefault();
                }
            });
        });

        document.addEventListener("htmx:afterSwap", function (event) {
            var el = event.target;
            if (
                el &&
                (el.id === "asset-altitude-chart-wrapper" ||
                    el.id === "asset-speed-chart-wrapper" ||
                    el.id === "asset-horizontal-speed-chart-wrapper" ||
                    el.id === "asset-downrange-chart-wrapper")
            ) {
                var chartContainer = document.getElementById(
                    "asset-altitude-chart-wrapper"
                );
                var speedContainer = document.getElementById(
                    "asset-speed-chart-wrapper"
                );
                var horizontalContainer = document.getElementById(
                    "asset-horizontal-speed-chart-wrapper"
                );
                var downrangeContainer = document.getElementById(
                    "asset-downrange-chart-wrapper"
                );
                var altRange = chartContainer
                    ? renderAltitudeChart(chartContainer)
                    : null;
                var speedRange = speedContainer
                    ? renderSpeedChart(speedContainer)
                    : null;
                var horizontalRange = horizontalContainer
                    ? renderHorizontalChart(horizontalContainer)
                    : null;
                var downrangeRange = downrangeContainer
                    ? renderDownrangeChart(downrangeContainer)
                    : null;
                var ranges = [
                    altRange,
                    speedRange,
                    horizontalRange,
                    downrangeRange,
                ].filter(Boolean);
                if (ranges.length > 0) {
                    var globalMin = Math.min.apply(
                        null,
                        ranges.map(function (r) {
                            return r.minTime;
                        })
                    );
                    var globalMax = Math.max.apply(
                        null,
                        ranges.map(function (r) {
                            return r.maxTime;
                        })
                    );
                    if (chartContainer && chartContainer._chartInstance) {
                        chartContainer._chartInstance.options.scales.x.min =
                            globalMin;
                        chartContainer._chartInstance.options.scales.x.max =
                            globalMax;
                        chartContainer._chartInstance.update();
                    }
                    if (speedContainer && speedContainer._chartInstance) {
                        speedContainer._chartInstance.options.scales.x.min =
                            globalMin;
                        speedContainer._chartInstance.options.scales.x.max =
                            globalMax;
                        speedContainer._chartInstance.update();
                    }
                    if (
                        horizontalContainer
                        && horizontalContainer._chartInstance
                    ) {
                        horizontalContainer._chartInstance.options.scales.x.min =
                            globalMin;
                        horizontalContainer._chartInstance.options.scales.x.max =
                            globalMax;
                        horizontalContainer._chartInstance.update();
                    }
                    if (
                        downrangeContainer
                        && downrangeContainer._chartInstance
                    ) {
                        downrangeContainer._chartInstance.options.scales.x.min =
                            globalMin;
                        downrangeContainer._chartInstance.options.scales.x.max =
                            globalMax;
                        downrangeContainer._chartInstance.update();
                    }
                }
            }
        });

    </script>
</body>
</html>
