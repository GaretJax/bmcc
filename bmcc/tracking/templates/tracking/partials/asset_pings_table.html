<div id="asset-pings"
     hx-get="{{ request.path }}"
     hx-trigger="every 5s"
     hx-swap="outerHTML"
     hx-vals='{"hx_section": "pings"}'>
    <div class="grid-x align-justify align-middle"
         style="margin-bottom: 0.75rem;"
         hx-boost="false">
        <div class="cell auto">
            <p class="muted">
                Updated at
                <strong data-role="updated-at">
                    {{ refreshed_at|date:"Y-m-d H:i:s" }}
                </strong>
                —
                Next refresh in
                <strong data-role="refresh-countdown">5s</strong>
            </p>
        </div>
        <div class="cell shrink">
            <span class="label secondary" data-role="refresh-status"></span>
        </div>
    </div>
    <table class="stack">
        <thead>
            <tr>
                <th>Beacon</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Altitude</th>
                <th>Reported at</th>
            </tr>
        </thead>
        <tbody>
            {% for ping in pings %}
                <tr>
                    <td>{{ ping.beacon.identifier }}</td>
                    <td>{{ ping.latitude|floatformat:5 }}</td>
                    <td>{{ ping.longitude|floatformat:5 }}</td>
                    <td>
                        {% if ping.altitude %}
                            {{ ping.altitude }} m
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>{{ ping.reported_at|date:"Y-m-d H:i" }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="5" class="text-center muted">No pings.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <script>
        (function () {
            var container = document.currentScript.closest("#asset-pings");
            if (!container) { return; }
            var statusEl = container.querySelector(
                "[data-role='refresh-status']"
            );
            var countdownEl = container.querySelector(
                "[data-role='refresh-countdown']"
            );
            var intervalSeconds = 5;

            function startCountdown() {
                var remaining = intervalSeconds;
                countdownEl.textContent = remaining + "s";
                var timer = setInterval(function () {
                    if (window.refreshPaused) {
                        countdownEl.textContent = "paused";
                        return;
                    }
                    remaining -= 1;
                    if (remaining <= 0) {
                        countdownEl.textContent = "0s";
                        clearInterval(timer);
                    } else {
                        countdownEl.textContent = remaining + "s";
                    }
                }, 1000);
            }

            startCountdown();

            container.addEventListener("htmx:beforeRequest", function () {
                if (statusEl) { statusEl.textContent = "Updating..."; }
            });
            container.addEventListener("htmx:afterSwap", function () {
                if (statusEl) { statusEl.textContent = ""; }
            });

        }());
    </script>
</div>
