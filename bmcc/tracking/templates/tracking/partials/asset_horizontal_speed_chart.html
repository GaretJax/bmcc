<div id="asset-horizontal-speed-chart-wrapper"
     hx-get="{{ request.path }}"
     hx-trigger="every 5s"
     hx-swap="outerHTML"
     hx-headers='{"HX-Section": "horizontal_speed"}'
     hx-vals='{"hx_section": "horizontal_speed"}'>
    <div class="grid-x align-justify align-middle"
         style="margin-bottom: 0.75rem;">
        <div class="cell auto">
            <p class="muted">
                Updated at
                <strong data-role="updated-at">
                    {{ refreshed_at|date:"Y-m-d H:i:s" }}
                </strong>
                â€”
                Next refresh in
                <strong data-role="refresh-countdown">5s</strong>
            </p>
        </div>
        <div class="cell shrink">
            <span class="label secondary" data-role="refresh-status"></span>
        </div>
    </div>
    <canvas id="horizontal-speed-chart" height="120"></canvas>
    {{ horizontal_speed_series|json_script:"horizontal-speed-series-data" }}
    {{ chart_bounds|json_script:"chart-bounds-data" }}
    <script>
        (function () {
            var container = document.currentScript.closest(
                "#asset-horizontal-speed-chart-wrapper"
            );
            if (!container) { return; }

            var statusEl = container.querySelector(
                "[data-role='refresh-status']"
            );
            var countdownEl = container.querySelector(
                "[data-role='refresh-countdown']"
            );
            var intervalSeconds = 5;

            function startCountdown() {
                var remaining = intervalSeconds;
                countdownEl.textContent = remaining + "s";
                var timer = setInterval(function () {
                    if (window.refreshPaused) {
                        countdownEl.textContent = "paused";
                        return;
                    }
                    remaining -= 1;
                    if (remaining <= 0) {
                        countdownEl.textContent = "0s";
                        clearInterval(timer);
                    } else {
                        countdownEl.textContent = remaining + "s";
                    }
                }, 1000);
            }
            startCountdown();

            container.addEventListener("htmx:beforeRequest", function () {
                if (statusEl) { statusEl.textContent = "Updating..."; }
            });
            container.addEventListener("htmx:afterSwap", function () {
                if (statusEl) { statusEl.textContent = ""; }
            });
        }());
    </script>
</div>
