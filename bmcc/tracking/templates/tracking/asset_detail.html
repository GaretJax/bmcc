{% extends "missions/base.html" %}

{% block title %}Asset: {{ asset.name }}{% endblock %}

{% block extra_head %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}

{% block content %}
<div class="card">
    <div class="grid-x align-justify align-middle"
         style="margin-bottom: 0.75rem;">
        <div class="cell auto">
            <h2 class="h4">{{ asset.name }}</h2>
            <p class="muted">
                Mission: {{ asset.mission.name }} &middot;
                Type: {{ asset.get_asset_type_display }}
                {% if asset.callsign %}
                    &middot; Callsign: {{ asset.callsign }}
                {% endif %}
                {% if asset.launched_at %}
                    &middot; Launched at {{ asset.launched_at|date:"Y-m-d H:i" }}
                    {% if asset.launch_site %}
                        from {{ asset.launch_site.name }}
                    {% endif %}
                {% endif %}
                {% if asset.landed_at %}
                    &middot; Landed at {{ asset.landed_at|date:"Y-m-d H:i" }}
                    {% if asset.landing_location %}
                        ({{ asset.landing_location.y|floatformat:5 }}, {{ asset.landing_location.x|floatformat:5 }})
                    {% endif %}
                {% endif %}
            </p>
        </div>
        <span class="label secondary">{{ asset.mission.name }}</span>
    </div>
    {% if asset.notes %}
        <p>{{ asset.notes }}</p>
    {% endif %}
{% if asset.asset_type == "balloon" and not asset.launched_at %}
        <form method="post"
              action="{% url 'missions:asset_mark_launched' mission_id=mission.pk asset_id=asset.pk %}"
              class="grid-x grid-margin-x">
            {% csrf_token %}
            <div class="cell medium-6">
                <label>Launch site
                    <select name="launch_site">
                        <option value="">Select launch site</option>
                        {% for site in mission.launch_site_candidates.all %}
                            <option value="{{ site.pk }}"
                                {% if asset.launch_site_id == site.pk %}selected{% endif %}>
                                {{ site.name }}
                            </option>
                        {% endfor %}
                    </select>
                </label>
            </div>
            <div class="cell medium-6">
                <label>Launched at
                    <input type="datetime-local"
                           name="launched_at"
                           value="{{ refreshed_at|date:'Y-m-d\\TH:i' }}">
                </label>
            </div>
            <div class="cell">
                <button type="submit" class="button success small">
                    Mark as launched
                </button>
            </div>
        </form>
    {% elif asset.asset_type == "balloon" and asset.launched_at and not asset.landed_at %}
        <form method="post"
              action="{% url 'missions:asset_mark_landed' mission_id=mission.pk asset_id=asset.pk %}"
              class="grid-x grid-margin-x">
            {% csrf_token %}
            <div class="cell medium-6">
                <label>Landing latitude
                    <input type="number" name="latitude" step="0.00001" required>
                </label>
            </div>
            <div class="cell medium-6">
                <label>Landing longitude
                    <input type="number" name="longitude" step="0.00001" required>
                </label>
            </div>
            <div class="cell medium-6">
                <label>Landed at
                    <input type="datetime-local"
                           name="landed_at"
                           value="{{ refreshed_at|date:'Y-m-d\\TH:i' }}">
                </label>
            </div>
            <div class="cell">
                <button type="submit" class="button warning small">
                    Mark as landed
                </button>
            </div>
        </form>
    {% endif %}
</div>

{% if asset.pings.exists %}
<div class="card">
    <div class="grid-x align-justify align-middle" style="margin-bottom: 0.75rem;">
        <div class="cell auto">
            <h3 class="h5">Track</h3>
            <p class="muted">All pings plotted on map</p>
        </div>
    </div>
    <div id="asset-track-map" style="height: 360px; border: 1px solid #e0e0e0;"></div>
    {{ path_points|json_script:"asset-track-points" }}
</div>
{% endif %}

<div class="card">
    <div class="grid-x align-justify align-middle"
         style="margin-bottom: 0.75rem;">
        <div class="cell auto">
            <h3 class="h5">Recent pings</h3>
            <p class="muted">Latest activity across all beacons</p>
        </div>
    </div>
    {% include "tracking/partials/asset_pings_table.html" %}
</div>

<div class="card">
    <div class="grid-x align-justify align-middle"
         style="margin-bottom: 0.75rem;">
        <div class="cell auto">
            <h3 class="h5">Altitude history</h3>
            <p class="muted">Full altitude history (pings with altitude)</p>
        </div>
    </div>
    {% include "tracking/partials/asset_altitude_chart.html" %}
</div>

<div class="card">
    <div class="grid-x align-justify align-middle"
         style="margin-bottom: 0.75rem;">
        <div class="cell auto">
            <h3 class="h5">Vertical speed</h3>
            <p class="muted">Derived speed by beacon (m/s)</p>
        </div>
    </div>
    {% include "tracking/partials/asset_speed_chart.html" %}
</div>

<div class="card">
    <div class="grid-x align-justify align-middle"
         style="margin-bottom: 0.75rem;">
        <div class="cell auto">
            <h3 class="h5">Horizontal speed</h3>
            <p class="muted">Derived ground speed by beacon (m/s)</p>
        </div>
    </div>
    {% include "tracking/partials/asset_horizontal_speed_chart.html" %}
</div>

{% if asset.launched_at and asset.launch_site %}
<div class="card">
    <div class="grid-x align-justify align-middle"
         style="margin-bottom: 0.75rem;">
        <div class="cell auto">
            <h3 class="h5">Downrange distance</h3>
            <p class="muted">Ground distance from launch site (m)</p>
        </div>
    </div>
    {% include "tracking/partials/asset_downrange_chart.html" %}
</div>
{% endif %}
{% endblock %}

{% block extra_body %}
{{ block.super }}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
  .emoji-icon {
    font-size: 2em;
    text-align: center;
    line-height: 24px;
  }
</style>
<script>
    (function () {
        var mapEl = document.getElementById("asset-track-map");
        if (!mapEl || !window.L) { return; }
        var pointsEl = document.getElementById("asset-track-points");
        var points = [];
        try {
            points = JSON.parse(pointsEl.textContent) || [];
        } catch (e) {
            points = [];
        }
        if (!points.length) { return; }
        var first = points[0];
        var map = L.map("asset-track-map").setView([first[1], first[2]], 9);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
        var coords = points.map(function (p) { return [p[1], p[2]]; });
        var line = L.polyline(coords, { color: "#000" }).addTo(map);
        map.fitBounds(line.getBounds(), { padding: [10, 10] });
        {% if asset.launched_at and asset.launch_site %}
        var launchIcon = L.divIcon({
            html: "&#x1F388",
            className: "emoji-icon",
            iconSize: [24, 24],
            iconAnchor: [18, 24],
        });
        L.marker(
            [{{ asset.launch_site.location.y }}, {{ asset.launch_site.location.x }}],
            { title: "Launch", icon: launchIcon }
        ).addTo(map);
        {% endif %}
        {% if asset.landed_at and asset.landing_location %}
        var landingIcon = L.divIcon({
            html: "&#x1F3C1;",
            className: "emoji-icon",
            iconSize: [24, 24],
            iconAnchor: [1, 25],
        });
        L.marker(
            [{{ asset.landing_location.y }}, {{ asset.landing_location.x }}],
            { title: "Landing", icon: landingIcon }
        ).addTo(map);
        {% endif %}
    }());
</script>
{% endblock %}
